---
- name: Extract and save certificate and private key from JSON cert_response
  hosts: localhost
  gather_facts: no
  vars:
    certificate_file: /path/to/certificate.pem  # Path to save the certificate
    private_key_file: /path/to/private_key.pem  # Path to save the private key

  tasks:
    - name: Remove enclosing quotes from JSON cert_response
      set_fact:
        cert_response_clean: "{{ cert_response | regex_replace('^\"|\"$', '') }}"

    - name: Split cert_response into lines
      set_fact:
        cert_lines: "{{ cert_response_clean | splitlines() }}"

    - name: Extract the certificate content
      set_fact:
        certificate_content: >-
          {{ cert_lines | select('search', '-----BEGIN CERTIFICATE-----') 
                        | map('regex_replace', '-----BEGIN CERTIFICATE-----|-----END CERTIFICATE-----', '') 
                        | join('\n') | trim }}

    - name: Extract the private key content
      set_fact:
        private_key_content: >-
          {{ cert_lines | select('search', '-----BEGIN RSA PRIVATE KEY-----') 
                        | map('regex_replace', '-----BEGIN RSA PRIVATE KEY-----|-----END RSA PRIVATE KEY-----', '') 
                        | join('\n') | trim }}

    - name: Save the cleaned certificate to a file
      copy:
        content: "{{ certificate_content }}"
        dest: "{{ certificate_file }}"
        mode: '0600'

    - name: Save the cleaned private key to a file
      copy:
        content: "{{ private_key_content }}"
        dest: "{{ private_key_file }}"
        mode: '0600'
